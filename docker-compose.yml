version: "3.7"

# YAML Anchors

x-deployment-env: &deployment-env
  ENV: ${ENV:-development}
  SG_ENV: ${SG_ENV:-development}
  TZ: $TZ

x-build-client-env: &build-client-env
  PLACEOS_BUILD_HOST: ${PLACEOS_BUILD_HOST:-build}
  PLACEOS_BUILD_PORT: ${PLACEOS_BUILD_PORT:-3000}

x-elastic-client-env: &elastic-client-env
  ELASTIC_HOST: ${ELASTIC_HOST:-elastic}
  ELASTIC_PORT: ${ELASTIC_PORT:-9200}

x-etcd-client-env: &etcd-client-env
  ETCD_HOST: ${ETCD_HOST:-etcd}
  ETCD_PORT: ${ETCD_PORT:-2379}

x-redis-client-env: &redis-client-env
  REDIS_URL: ${REDIS_URL:-redis://redis:6379}

x-rethinkdb-client-env: &rethinkdb-client-env
  RETHINKDB_HOST: ${RETHINKDB_HOST:-rethink}
  RETHINKDB_PORT: ${RETHINKDB_PORT:-28015}
  RETHINKDB_DB: ${RETHINKDB_DB:-place_development}

x-search-ingest-client-env: &search-ingest-client-env
  SEARCH_INGEST_URI: ${SEARCH_INGEST_URI:-http://search-ingest:3000}

services:
  test: # Rest API
    image: placeos/service-spec-runner:${CRYSTAL_VERSION:-1.4.1}
    volumes:
      - ${PWD}/spec:/app/spec
      - ${PWD}/src:/app/src
      - ${PWD}/lib:/app/lib
      - ${PWD}/shard.lock:/app/shard.lock
      - ${PWD}/shard.override.yml:/app/shard.override.yml
      - ${PWD}/shard.yml:/app/shard.yml
      - ${PWD}/coverage:/app/coverage
    depends_on:
      - auth
      - build
      - core
      - elastic
      - etcd
      - redis
      - rethink
      - search-ingest
    environment:
      # Environment
      GITHUB_ACTION: ${GITHUB_ACTION:-}
      <<: *deployment-env
      # Service Hosts
      <<: *build-client-env
      <<: *elastic-client-env
      <<: *etcd-client-env
      <<: *redis-client-env
      <<: *rethinkdb-client-env

  build:
    image: placeos/build:${PLACE_BUILD_TAG:-nightly}
    restart: always
    hostname: build
    environment:
      <<: *deployment-env

  elastic:
    image: blacktop/elasticsearch:${ELASTIC_VERSION:-7.9.1}
    restart: always
    healthcheck:
      test: wget -q --no-verbose --tries=1 --spider http://localhost:9200/_cat/health
    environment:
      discovery.type: single-node

  etcd:
    image: bitnami/etcd:${ETCD_VERSION:-3.5.1}
    restart: always
    hostname: etcd
    healthcheck:
      test: etcdctl endpoint health
    environment:
      ALLOW_NONE_AUTHENTICATION: "yes"

  redis:
    image: eqalpha/keydb:alpine
    restart: always
    hostname: redis
    healthcheck:
      test: redis-cli ping

  rethink:
    image: rethinkdb:${RETHINKDB_VERSION:-2.4}
    restart: always
    hostname: rethink
    healthcheck:
      # Check if the DB's port is open
      test: "bash -c ': &>/dev/null </dev/tcp/127.0.0.1/28015'"

  search-ingest: # RethinkDB to Elasticsearch Service
    image: placeos/search-ingest:nightly
    restart: always
    hostname: search-ingest
    depends_on:
      - elastic
      - rethink
    environment:
      LOG_LEVEL: trace
      # Service Hosts
      <<: *rethinkdb-client-env
      <<: *elastic-client-env
      # Environment
      <<: *deployment-env

  auth: # Authentication Service
    image: placeos/auth:nightly
    restart: always
    hostname: auth
    depends_on:
      - redis
      - rethink
    environment:
      <<: *rethinkdb-client-env
      <<: *redis-client-env
      COAUTH_NO_SSL: "true"
      TZ: $TZ
      PLACE_URI: https://${PLACE_DOMAIN:-localhost:8443}

  core: # Module coordinator
    # image: placeos/core:${PLACE_CORE_TAG:-nightly}
    image: ghcr.io/placeos/core:feat-build
    restart: always
    hostname: core
    depends_on:
      - etcd
      - redis
      - rethink
    ulimits:
      nofile: 40000
      core:
        soft: 0
        hard: 0
    healthcheck:
      start_period: 30s
    environment:
      # Service Hosts
      <<: *etcd-client-env
      <<: *redis-client-env
      <<: *rethinkdb-client-env
      # Environment
      <<: *deployment-env
